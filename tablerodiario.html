<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tablero Diario</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; text-align: center; }
.logo { max-width: 250px; margin-bottom: 10px; }
h1 { margin-bottom: 10px; color: #333; }
#fecha-hora { font-size: 18px; font-weight: bold; color: #444; margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
th, td { padding: 8px 12px; border: 1px solid #ddd; text-align: center; }
th { background: #048c7c; color: white; font-weight: bold; }
tr:nth-child(even) { background: #f9f9f9; }
tr:hover { background: #e3f2fd; }
#historial { margin-top: 20px; }
#selector-semana { padding: 5px; font-size: 16px; margin-top: 5px; }
</style>
</head>
<body>
  
  <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 10px;">
    <button onclick="history.back()" style="padding: 8px 12px; font-size: 14px; cursor: pointer;">Volver</button>
    <button onclick="alert('Botón1 presionado')" style="padding: 8px 12px; font-size: 14px; cursor: pointer;">Botón1</button>
  </div>
  
<img src="Logo.png" alt="Logo de la empresa" class="logo">
<h1>ASAKAI - TABLERO DIARIO</h1>
<div id="fecha-hora"></div>

<table id="tabla-datos">
  <thead></thead>
  <tbody></tbody>
</table>

<!-- Historial Semanal -->
<div id="historial" style="margin-top:20px; display:flex; align-items:center; justify-content:center; gap:10px;">
  <span><strong>Historial Semanal:</strong></span>
  <select id="selector-semana"></select>
</div>

</div>

<script>
const endpoint = "https://script.google.com/macros/s/AKfycbyJNsAelNyKhOrYQncIoHY8XBwUHbnIcxsvkNQo2RSDeN5Z9Z3jK_eUIemz3i-7iOQ-/exec";

// 🔹 Reloj en tiempo real
function actualizarReloj() {
  const ahora = new Date();
  const opciones = { weekday: "long", year: "numeric", month: "long", 
                     day: "numeric", hour: "2-digit", minute: "2-digit", second: "2-digit" };
  document.getElementById("fecha-hora").textContent = ahora.toLocaleDateString("es-ES", opciones);
}
setInterval(actualizarReloj, 1000);
actualizarReloj();

// 🔹 Función de colores (toda tu lógica actual se mantiene)
function colorSegunObjetivo(nombreFila, objetivo, valor) {
  if (!nombreFila || valor === undefined || valor === null) return "";
  const nombreStr = String(nombreFila).trim().toUpperCase();

  const valorNum = Number(String(valor).replace("%","").trim().replace(",",".")); 
  const objNum = Number(String(objetivo).replace(/[^0-9.]/g,"").trim().replace(",",".")); 

  if (isNaN(valorNum)) return "";

  if (["ACCIDENTES","RECLAMOS CLIENTE (RED)"].includes(nombreStr)) {
    return valorNum === 0 ? "#b6fcb6" : "#fcb6b6";
  }

  if (nombreStr === "BUENO DIRECTO") {
    if (isNaN(objNum)) return "";
    return valorNum > objNum ? "#b6fcb6" : "#fcb6b6";
  }

  if (["PARADAS DE LÍNEA","PARADAS DE LÍNEA POR MP"].includes(nombreStr)) {
    return valorNum < 150 ? "#b6fcb6" : "#fcb6b6";
  }

  if (nombreStr === "PARADAS DE LÍNEA POR LOGÍSTICA") {
    if (isNaN(valorNum) || isNaN(objNum)) return "";
    return valorNum > objNum ? "#fcb6b6" : "#b6fcb6";
  }

  if (["UNIDADES RETENIDAS PISO","UNIDADES RETENIDAS MASIVA"].includes(nombreStr)) {
    if (isNaN(valorNum) || isNaN(objNum)) return "";
    return valorNum > objNum ? "#fcb6b6" : "#b6fcb6";
  }

  // 🔹 REPARADAS/RETENIDAS invertida
  if (nombreStr === "REPARADAS/RETENIDAS") {
    if (isNaN(valorNum) || isNaN(objNum)) return "";
    return valorNum < objNum ? "#fcb6b6" : "#b6fcb6";
  }

  if (["CUMPLIMIENTO PLAN DESPACHO","RELACIÓN DESPACHADO VS PRODUCIDO"].includes(nombreStr)) {
    if (isNaN(valorNum) || isNaN(objNum)) return "";
    return valorNum >= objNum ? "#b6fcb6" : "#fcb6b6"; 
  }

  if (["AUSENTISMO REAL","AUSENTISMO GESTIONABLE","TE/TR"].includes(nombreStr)) {
    if (!objetivo) return "";
    let objValue = parseFloat(objetivo.replace("<","").replace(">","").replace(",",".").trim());
    if (isNaN(objValue)) return "";

    if (objetivo.includes("<")) {
      return valorNum < objValue ? "#b6fcb6" : "#fcb6b6";
    } else if (objetivo.includes(">")) {
      return valorNum > objValue ? "#b6fcb6" : "#fcb6b6";
    } else {
      return valorNum <= objValue ? "#b6fcb6" : "#fcb6b6";
    }
  }

  if (!isNaN(objNum)) {
    return valorNum >= objNum ? "#b6fcb6" : "#fcb6b6";
  }

  return "";
}

// 🔹 Cargar datos del Google Sheet
async function cargarDatos() {
  try {
    const res = await fetch(endpoint);
    const data = await res.json();
    if (!data || data.length === 0) return;

    // Guardar datos en LocalStorage por semana
    const semana = (new Date()).toISOString().slice(0,10);
    let historial = JSON.parse(localStorage.getItem("historialTablero") || "{}");
    historial[semana] = data;
    localStorage.setItem("historialTablero", JSON.stringify(historial));

    // Actualizar selector de semanas
    actualizarSelectorSemana(historial);

    // Mostrar datos de la semana actual
    mostrarTabla(data);
  } catch (err) {
    console.error("Error cargando datos:", err);
  }
}

// 🔹 Mostrar tabla
function mostrarTabla(data) {
  const tabla = document.getElementById("tabla-datos");
  const thead = tabla.querySelector("thead");
  const tbody = tabla.querySelector("tbody");

  const columnas = Object.keys(data[0]);
  thead.innerHTML = "<tr>" + columnas.map(h => `<th>${h}</th>`).join("") + "</tr>";

  const colNombreFila = "INDICADORES";  
  const colObjetivo = "OBJ";             
  const columnasDias = ["LUN","MAR","MIE","JUE","VIE"];  

  tbody.innerHTML = data.map(r => {
    let fila = "<tr>";
    const nombreFila = r[colNombreFila];
    const objetivo = r[colObjetivo];

    columnas.forEach(col => {
      let valor = r[col];
      let color = "";

      if (columnasDias.includes(col)) {
        color = colorSegunObjetivo(nombreFila, objetivo, valor);
      }

      fila += `<td style="background-color:${color}">${valor}</td>`;
    });

    fila += "</tr>";
    return fila;
  }).join("");
}

// 🔹 Actualizar selector de semanas
function actualizarSelectorSemana(historial) {
  const selector = document.getElementById("selector-semana");
  selector.innerHTML = "";
  const semanas = Object.keys(historial).sort();
  semanas.forEach(s => {
    const option = document.createElement("option");
    option.value = s;
    option.textContent = s;
    selector.appendChild(option);
  });
}

// 🔹 Cambio de semana
document.getElementById("selector-semana").addEventListener("change", function() {
  const semana = this.value;
  const historial = JSON.parse(localStorage.getItem("historialTablero") || "{}");
  if (historial[semana]) {
    mostrarTabla(historial[semana]);
  }
});

// Cargar al inicio
cargarDatos();

// Refrescar cada 10 minutos
setInterval(cargarDatos, 600000);
</script>

</body>
</html>


